<!-- src/components/student/StudentMain.vue -->
<template>
  <div class="hero-wrap py-5">
    <!-- ê¸°ëŠ¥ ì¹´ë“œ 3ê°œ -->
    <div class="container mt-4">
      <div class="row g-4">
        <!-- 1) AI ë¬¸ì œì€í–‰ ì‹œìŠ¤í…œ -->
        <div class="col-12 col-md-6 col-lg-4">
          <router-link to="/student/cbt/step01" class="text-decoration-none">
            <div class="card feature-card active h-100 rounded-4 border-0 shadow-sm">
              <div class="card-body p-4">
                <!-- ì•„ì´ì½˜ + NEW ë±ƒì§€ -->
                <div class="d-flex align-items-start justify-content-between">
                  <div class="icon-blob">
                    <!-- ê°„ë‹¨í•œ ë¬¸ì„œ ì•„ì´ì½˜ SVG -->
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                      <path
                        d="M14 2H6a2 2 0 0 0-2 2v16a2
                      2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                      />
                      <path d="M14 2v6h6" />
                    </svg>
                  </div>
                  <span class="badge rounded-pill bg-success-subtle text-success fw-semibold"
                    >NEW</span
                  >
                </div>

                <h4 class="mt-3 mb-2 text-dark fw-bold">ë¬¸ì œì€í–‰ CBT</h4>
                <p class="text-secondary mb-3">
                  ë¬¸ì œì€í–‰ì—ì„œ 15,000+ ê²€ì¦ëœ ë¬¸ì œë¥¼ ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ë¶„ì„í•˜ì—¬ ì‹¤ì‹œê°„ìœ¼ë¡œ CBTë¥¼
                  ì¶œì œí•©ë‹ˆë‹¤. ê³¼ëª©ë³„, ë‹¨ì›ë³„ ì²´ê³„ì ì¸ ë¶„ë¥˜ë¡œ ë‹¤ì–‘í•œ ë¬¸ì œë¥¼ ì‰½ê²Œ ì°¾ê³  ë°”ë¡œ í’€ ìˆ˜
                  ìˆìŠµë‹ˆë‹¤.
                </p>

                <ul class="list-unstyled m-0 text-secondary small">
                  <li class="d-flex align-items-start gap-2 mb-2">
                    <span class="check text-success">âœ“</span> ë°©ëŒ€í•œ ë¬¸ì œ ì€í–‰ ë°ì´í„°
                  </li>
                  <li class="d-flex align-items-start gap-2 mb-2">
                    <span class="check text-success">âœ“</span> ë‹¤ì–‘í•œ ê²€ì¦ êµê³¼ì„œ ê¸°ë°˜ ë¬¸ì œ ì§€ì›
                  </li>
                  <li class="d-flex align-items-start gap-2">
                    <span class="check text-success">âœ“</span> ì‹¤ì‹œê°„ ìƒì„± & ì›í•˜ëŠ” ë‹¨ì› í•„í„°ë§
                  </li>
                </ul>
              </div>
            </div>
          </router-link>
        </div>

        <!-- 2) ìŠ¤ë§ˆíŠ¸ ì‹œí—˜ì§€ ìƒì„± -->
        <div class="col-12 col-md-6 col-lg-4">
          <router-link to="/student/class-room/my-class" class="text-decoration-none">
            <div class="card feature-card h-100 rounded-4 border-0 shadow-sm">
              <div class="card-body p-4">
                <div class="d-flex align-items-start justify-content-between">
                  <div class="icon-blob">
                    <!-- ìº˜ë¦°ë” ëŠë‚Œ ì•„ì´ì½˜ -->
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M7 2v2M17 2v2M3 7h18M5 22h14a2 2 0 0 0 2-2V7H3v13a2 2 0 0 0 2 2Z" />
                    </svg>
                  </div>
                  <span class="badge rounded-pill bg-warning-subtle text-warning fw-semibold"
                    >HOT</span
                  >
                </div>

                <h4 class="mt-3 mb-2 text-dark fw-bold">ë˜‘ë˜‘í•œ ìš°ë¦¬ë°˜</h4>
                <p class="text-secondary mb-3">
                  ë˜‘ë˜‘í•œ ìš°ë¦¬ë°˜ê³¼ í•¨ê»˜ë¼ë©´, ì˜¨ë¼ì¸ ì‹œí—˜ë„ êµì‹¤ì²˜ëŸ¼ ì‹¤ì‹œê°„ìœ¼ë¡œ! ì²´ê³„ì ìœ¼ë¡œ ê³µì •í•œ
                  ì‹œí—˜ ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤. ëª¨ë‘ê°€ ë™ì‹œì— í’€ê³  ì¦‰ì‹œ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
                </p>

                <ul class="list-unstyled m-0 text-secondary small">
                  <li class="d-flex align-items-start gap-2 mb-2">
                    <span class="check text-success">âœ“</span> êµì‹¤ì²˜ëŸ¼ ëª¨ë‘ê°€ ë™ì‹œì— ì‹œì‘í•˜ëŠ” ì‹¤ì‹œê°„
                    ì‹œí—˜
                  </li>
                  <li class="d-flex align-items-start gap-2 mb-2">
                    <span class="check text-success">âœ“</span> ë¬¸ì œ í’€ì´ í›„ ì¦‰ì‹œ í™•ì¸ë˜ëŠ” ê²°ê³¼
                  </li>
                  <li class="d-flex align-items-start gap-2">
                    <span class="check text-success">âœ“</span> ê³µì •í•˜ê³  íˆ¬ëª…í•œ ì˜¨ë¼ì¸ ì‹œí—˜ í™˜ê²½
                  </li>
                </ul>
              </div>
            </div>
          </router-link>
        </div>

        <!-- 3) ì‹¬í™” ì„±ì  ë¶„ì„ -->
        <div class="col-12 col-md-6 col-lg-4">
          <router-link to="/student/report" class="text-decoration-none">
            <div class="card feature-card h-100 rounded-4 border-0 shadow-sm">
              <div class="card-body p-4">
                <div class="d-flex align-items-start justify-content-between">
                  <div class="icon-blob">
                    <!-- ì°¨íŠ¸ ì•„ì´ì½˜ -->
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M3 3v18h18M7 15v3M11 12v6M15 9v9M19 6v12" />
                    </svg>
                  </div>
                </div>

                <h4 class="mt-3 mb-2 text-dark fw-bold">ì‹œí—˜ ì„±ì  ë¶„ì„</h4>
                <p class="text-secondary mb-3">
                  ì ìˆ˜ë§Œ í™•ì¸í•˜ëŠ” ì‹œëŒ€ëŠ” ë! í‰ê°€ ê²°ê³¼ ìš”ì•½ìœ¼ë¡œ í° ê·¸ë¦¼ì„ ë³´ê³ , ë¬¸í•­ ë¶„ì„ ë¦¬í¬íŠ¸ë¡œ
                  ì„¸ë¶€ ë°ì´í„°ë¥¼ íŒŒì•…í•˜ë©°, ì„±ì  ë¶„ì„ìœ¼ë¡œ í•™ìŠµ ì„±ì¥ì„ ì´ëŒì–´ê°‘ë‹ˆë‹¤.
                </p>

                <ul class="list-unstyled m-0 text-secondary small">
                  <li class="d-flex align-items-start gap-2 mb-2">
                    <span class="check text-success">âœ“</span> ì„±ì  ë¶„ì„
                  </li>
                  <li class="d-flex align-items-start gap-2 mb-2">
                    <span class="check text-success">âœ“</span> ë¬¸í•­ ë¶„ì„ ë¦¬í¬íŠ¸
                  </li>
                  <li class="d-flex align-items-start gap-2">
                    <span class="check text-success">âœ“</span> í‰ê°€ ê²°ê³¼ ìš”ì•½
                  </li>
                </ul>
              </div>
            </div>
          </router-link>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue'
import wsService from '@/services/websocket'
import classApi from '@/services/classApi'

// í˜„ì¬ ì‚¬ìš©ì ì •ë³´
const userInfo = ref(JSON.parse(localStorage.getItem('userInfo') || '{}'))
const classInfo = ref(null)

// WebSocket ì—°ê²° í•¨ìˆ˜
const connectToClassWebSocket = async () => {
  try {
    // í•™ìƒì˜ ë°˜ ì •ë³´ ì¡°íšŒ
    const response = await classApi.getStudentClass()
    if (response.data && response.data.success && response.data.data) {
      classInfo.value = response.data.data

      // WebSocket ì—°ê²°
      if (classInfo.value.classId) {
        const userId = userInfo.value.id || userInfo.value.userId
        const userName = userInfo.value.fullName || userInfo.value.name
        const channelName = `class-${classInfo.value.classId}`

        console.log('ğŸ“ í•™ìƒ WebSocket ì—°ê²° ì‹œì‘:', {
          classId: classInfo.value.classId,
          userId: userId,
          userName: userName,
          channelName: channelName
        })

        // ê¸°ì¡´ ì—°ê²°ì´ ìˆìœ¼ë©´ ëŠê¸°
        if (wsService.isConnected()) {
          wsService.disconnect()
        }

        // ìƒˆë¡œ ì—°ê²°
        await wsService.connect(
          channelName,
          userId,
          userName,
          'STUDENT',
          {
            onOnlineStatus: (status) => {
              console.log('ğŸ“¡ í•™ìƒ ì˜¨ë¼ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸:', status)
            }
          }
        )

        console.log('âœ… í•™ìƒ WebSocket ì—°ê²° ì„±ê³µ')

        // ì˜¨ë¼ì¸ ìƒíƒœ ì „ì†¡
        wsService.updateOnlineStatus(channelName, userId, userName, 'STUDENT', 'ONLINE')
      }
    }
  } catch (error) {
    console.error('âŒ í•™ìƒ WebSocket ì—°ê²° ì‹¤íŒ¨:', error)
  }
}

onMounted(() => {
  // í•™ìƒì´ ë¡œê·¸ì¸í•˜ë©´ ë°”ë¡œ WebSocket ì—°ê²°
  if (userInfo.value && userInfo.value.role === 'STUDENT') {
    connectToClassWebSocket()
  }
})

onUnmounted(() => {
  // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ì—°ê²° í•´ì œ
  if (wsService.isConnected()) {
    const userId = userInfo.value.id || userInfo.value.userId
    const userName = userInfo.value.fullName || userInfo.value.name
    const channelName = classInfo.value ? `class-${classInfo.value.classId}` : null

    if (channelName) {
      // ì˜¤í”„ë¼ì¸ ìƒíƒœ ì „ì†¡
      wsService.updateOnlineStatus(channelName, userId, userName, 'STUDENT', 'OFFLINE')
      wsService.removeUser(channelName, userId, userName, 'STUDENT')
    }

    wsService.disconnect()
  }
})
</script>

<style scoped>
/* ë°°ê²½ ì˜ì—­ (ì—°í•œ íšŒìƒ‰ + íŒ¨í„´ ëŠë‚Œ) */
.hero-wrap {
  background: linear-gradient(180deg, #f6f8fc 0%, #f8fafc 100%);
  min-height: 60vh;
}

/* ìƒë‹¨ íƒ­ ê°ì‹¸ëŠ” ì˜ì—­ ì—¬ë°±/ë‘¥ê·¼ëª¨ì„œë¦¬ */
.nav-surface {
  border-radius: 18px;
}

/* ì¹´ë“œ ê³µí†µ */
.feature-card {
  transition:
    box-shadow 0.2s ease,
    transform 0.15s ease,
    border-color 0.2s ease;
  background-color: #fff;
}

.feature-card.active {
  box-shadow: 0 10px 24px rgba(33, 114, 255, 0.08) !important;
}

/* hover íš¨ê³¼ */
.feature-card:hover {
  transform: translateY(-2px);
  outline: 2px solid rgba(33, 114, 255, 0.35);
  box-shadow: 0 14px 30px rgba(0, 0, 0, 0.08);
}

/* ì•„ì´ì½˜ íŒŒë€ ì›í˜• ë°°ê²½ */
.icon-blob {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: grid;
  place-items: center;
  background: #0d6efd; /* Bootstrap primary */
  color: #fff;
  box-shadow: 0 6px 18px rgba(13, 110, 253, 0.2);
}

/* ì²´í¬ ë§ˆí¬ ì •ë ¬ìš© */
.check {
  line-height: 1.2;
  font-weight: 700;
}
</style>
