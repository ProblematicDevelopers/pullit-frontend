<template>
  <div class="container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light">
    <div class="row w-100 justify-content-center">
      <div class="col-12 col-md-8 col-lg-6 col-xl-5">
        <div class="card shadow-lg border-0">
          <div class="card-header bg-primary text-white text-center py-4">
            <h3 class="mb-0 fw-bold">
              <i class="fas fa-user-plus me-2"></i>
              íšŒì›ê°€ì…
            </h3>
          </div>
          
          <div class="card-body p-4 p-md-5">
            <!-- ë‹¨ê³„ í‘œì‹œ -->
            <div class="step-indicator mb-4">
              <div class="row">
                <div class="col-4">
                  <div class="step" :class="{ active: signupStep === 1, completed: signupStep > 1 }">
                    <div class="step-number">1</div>
                    <div class="step-text">ì•½ê´€ë™ì˜<br/>ìœ í˜•ì„ íƒ</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="step" :class="{ active: signupStep === 2, completed: signupStep > 2 }">
                    <div class="step-number">2</div>
                    <div class="step-text">íœ´ëŒ€í° ì¸ì¦</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="step" :class="{ active: signupStep === 3 }">
                    <div class="step-number">3</div>
                    <div class="step-text">ì •ë³´ ì…ë ¥</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step 1: ì•½ê´€ë™ì˜ ë° ê°€ì…ìœ í˜• ì„ íƒ -->
            <div v-if="signupStep === 1">
              <h5 class="section-title mb-4">
                <i class="fas fa-file-contract me-2"></i>
                ì´ìš©ì•½ê´€ ë™ì˜
              </h5>
              
              <!-- ì „ì²´ ë™ì˜ -->
              <div class="form-check mb-3">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="agreeAll"
                  @change="toggleAllAgreements"
                  v-model="agreements.all"
                >
                <label class="form-check-label fw-bold" for="agreeAll">
                  ì „ì²´ ë™ì˜
                </label>
              </div>
              
              <hr class="my-4">
              
              <!-- ê°œë³„ ì•½ê´€ -->
              <div class="form-check mb-3">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="agreeTerms"
                  v-model="agreements.terms"
                  @change="checkIndividualAgreements"
                >
                <label class="form-check-label" for="agreeTerms">
                  [í•„ìˆ˜] ì´ìš©ì•½ê´€ ë™ì˜
                  <a href="#" class="text-decoration-none ms-2">ë³´ê¸°</a>
                </label>
              </div>
              
              <div class="form-check mb-3">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="agreePrivacy"
                  v-model="agreements.privacy"
                  @change="checkIndividualAgreements"
                >
                <label class="form-check-label" for="agreePrivacy">
                  [í•„ìˆ˜] ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜
                  <a href="#" class="text-decoration-none ms-2">ë³´ê¸°</a>
                </label>
              </div>
              
              <div class="form-check mb-4">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="agreeMarketing"
                  v-model="agreements.marketing"
                  @change="checkIndividualAgreements"
                >
                <label class="form-check-label" for="agreeMarketing">
                  [ì„ íƒ] ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜
                </label>
              </div>

              <!-- ì‚¬ìš©ì ìœ í˜• ì„ íƒ -->
              <h5 class="section-title mb-4">
                <i class="fas fa-users me-2"></i>
                ê°€ì… ìœ í˜• ì„ íƒ
              </h5>
              
              <div class="row g-3 mb-4">
                <div class="col-6">
                  <div
                    class="user-type-card"
                    :class="{ active: signupForm.userType === 'teacher' }"
                    @click="signupForm.userType = 'teacher'"
                  >
                    <div class="user-type-icon">
                      <i class="fas fa-chalkboard-teacher fa-2x"></i>
                    </div>
                    <h6 class="user-type-title">ì„ ìƒë‹˜</h6>
                  </div>
                </div>
                <div class="col-6">
                  <div
                    class="user-type-card"
                    :class="{ active: signupForm.userType === 'student' }"
                    @click="signupForm.userType = 'student'"
                  >
                    <div class="user-type-icon">
                      <i class="fas fa-graduation-cap fa-2x"></i>
                    </div>
                    <h6 class="user-type-title">í•™ìƒ</h6>
                  </div>
                </div>
              </div>

              <!-- ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ -->
              <div class="d-grid">
                <button
                  @click="nextStep"
                  class="btn btn-primary btn-lg fw-bold"
                  :disabled="!canProceedToStep2"
                >
                  ë‹¤ìŒ ë‹¨ê³„
                  <i class="fas fa-arrow-right ms-2"></i>
                </button>
              </div>
            </div>

            <!-- Step 2: íœ´ëŒ€í° ì¸ì¦ -->
            <div v-if="signupStep === 2">
              <h5 class="section-title mb-4">
                <i class="fas fa-mobile-alt me-2"></i>
                íœ´ëŒ€í° ì¸ì¦
              </h5>
              
              <!-- íœ´ëŒ€í° ë²ˆí˜¸ ì…ë ¥ -->
              <div class="mb-3">
                <label for="phone" class="form-label fw-bold">íœ´ëŒ€í° ë²ˆí˜¸</label>
                <div class="input-group">
                  <input
                    type="tel"
                    class="form-control"
                    id="phone"
                    v-model="signupForm.phone"
                    @input="formatPhone"
                    placeholder="010-0000-0000"
                    maxlength="13"
                    :disabled="phoneVerified"
                  >
                  <button
                    class="btn btn-outline-primary"
                    type="button"
                    @click="sendVerificationCode"
                    :disabled="!isValidPhone || phoneVerified"
                  >
                    {{ phoneVerified ? 'ì¸ì¦ì™„ë£Œ' : (verificationSent ? 'ì¬ì „ì†¡' : 'ì¸ì¦ë²ˆí˜¸ ì „ì†¡') }}
                  </button>
                </div>
              </div>

              <!-- ì¸ì¦ë²ˆí˜¸ ì…ë ¥ -->
              <div v-if="verificationSent" class="mb-3">
                <label for="verificationCode" class="form-label fw-bold">ì¸ì¦ë²ˆí˜¸</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="verificationCode"
                    v-model="verificationCode"
                    placeholder="ì¸ì¦ë²ˆí˜¸ 6ìë¦¬"
                    maxlength="6"
                    :disabled="phoneVerified"
                  >
                  <button
                    class="btn"
                    :class="phoneVerified ? 'btn-success' : 'btn-outline-success'"
                    type="button"
                    @click="verifyPhone"
                    :disabled="phoneVerified"
                  >
                    {{ phoneVerified ? 'ì¸ì¦ì™„ë£Œ' : 'í™•ì¸' }}
                  </button>
                </div>
                <div class="mt-2">
                  <small v-if="!phoneVerified" class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    {{ verificationTimer }}ì´ˆ ë‚¨ìŒ
                  </small>
                  <small v-if="phoneVerified" class="text-success">
                    <i class="fas fa-check-circle me-1"></i>
                    íœ´ëŒ€í° ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
                  </small>
                </div>
              </div>

              <!-- ë‹¨ê³„ ì´ë™ ë²„íŠ¼ -->
              <div class="d-flex gap-3">
                <button @click="prevStep" class="btn btn-secondary flex-fill">
                  <i class="fas fa-arrow-left me-2"></i>
                  ì´ì „
                </button>
                <button
                  @click="nextStep"
                  class="btn btn-primary flex-fill"
                  :disabled="!phoneVerified"
                >
                  ë‹¤ìŒ ë‹¨ê³„
                  <i class="fas fa-arrow-right ms-2"></i>
                </button>
              </div>
            </div>

            <!-- Step 3: ì •ë³´ ì…ë ¥ -->
            <div v-if="signupStep === 3">
              <h5 class="section-title mb-4">
                <i class="fas fa-edit me-2"></i>
                íšŒì› ì •ë³´ ì…ë ¥
              </h5>
              
              <form @submit.prevent="handleSignup">
                <!-- ì•„ì´ë”” ì…ë ¥ -->
                <div class="mb-3">
                  <label for="username" class="form-label fw-bold">ì•„ì´ë””</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      id="username"
                      v-model="signupForm.username"
                      @input="checkUsernameAvailability"
                      placeholder="ì˜ë¬¸, ìˆ«ì ì¡°í•© 4-20ì"
                      required
                      minlength="4"
                      maxlength="20"
                    >
                    <button
                      type="button"
                      class="btn"
                      :class="usernameAvailable ? 'btn-success' : 'btn-outline-primary'"
                      @click="checkUsernameAvailability"
                      :disabled="usernameAvailable"
                    >
                      {{ usernameAvailable ? 'í™•ì¸ì™„ë£Œ' : 'ì¤‘ë³µí™•ì¸' }}
                    </button>
                  </div>
                  <div v-if="usernameCheckMessage" class="form-text" :class="usernameAvailable ? 'text-success' : 'text-danger'">
                    {{ usernameCheckMessage }}
                  </div>
                </div>

                <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
                <div class="mb-3">
                  <label for="password" class="form-label fw-bold">ë¹„ë°€ë²ˆí˜¸</label>
                  <div class="input-group">
                    <input
                      :type="showPassword ? 'text' : 'password'"
                      class="form-control"
                      id="password"
                      v-model="signupForm.password"
                      @input="checkPasswordStrength"
                      placeholder="ì˜ë¬¸(ëŒ€+ì†Œ), ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•© 9-20ì"
                      required
                      minlength="9"
                      maxlength="20"
                    >
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      @click="togglePasswordVisibility"
                      title="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°"
                    >
                      <i :class="showPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                    </button>
                  </div>
                  <div v-if="passwordStrength" class="mt-2">
                    <div class="d-flex align-items-center">
                      <span class="me-2">ë³´ì•ˆë„:</span>
                      <div class="progress flex-grow-1 me-2" style="height: 8px;">
                        <div 
                          class="progress-bar" 
                          :class="passwordStrengthClass"
                          :style="{ width: passwordStrengthWidth }"
                        ></div>
                      </div>
                      <small class="text-muted">{{ passwordStrengthText }}</small>
                    </div>
                  </div>
                </div>

                <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
                <div class="mb-3">
                  <label for="passwordConfirm" class="form-label fw-bold">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                  <div class="input-group">
                    <input
                      :type="showPasswordConfirm ? 'text' : 'password'"
                      class="form-control"
                      id="passwordConfirm"
                      v-model="signupForm.passwordConfirm"
                      placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                      required
                    >
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      @click="togglePasswordConfirmVisibility"
                      title="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°"
                    >
                      <i :class="showPasswordConfirm ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                    </button>
                  </div>
                  <div v-if="signupForm.passwordConfirm" class="form-text" :class="passwordsMatch ? 'text-success' : 'text-danger'">
                    {{ passwordsMatch ? 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤' : 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤' }}
                  </div>
                </div>

                <!-- ì´ë©”ì¼ ì…ë ¥ -->
                <div class="mb-3">
                  <label for="email" class="form-label fw-bold">ì´ë©”ì¼</label>
                  <input
                    type="email"
                    class="form-control"
                    :class="{'is-invalid': !emailValid && emailErrorMessage, 'is-valid': emailValid}"
                    id="email"
                    v-model="signupForm.email"
                    @blur="checkEmailFormat"
                    @input="checkEmailFormat"
                    placeholder="example@email.com"
                    required
                  >
                  <div v-if="emailErrorMessage" class="invalid-feedback">{{ emailErrorMessage }}</div>
                  <div v-else-if="emailValid" class="valid-feedback">ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.</div>
                </div>

                <!-- ìƒë…„ì›”ì¼ ì…ë ¥ -->
                <div class="mb-3">
                  <label for="birthDate" class="form-label fw-bold">ìƒë…„ì›”ì¼</label>
                  <input
                    type="date"
                    class="form-control"
                    id="birthDate"
                    v-model="signupForm.birthDate"
                    required
                  >
                </div>

                <!-- í•™êµ ê²€ìƒ‰ -->
                <div class="mb-4">
                  <label for="school" class="form-label fw-bold">í•™êµ ì •ë³´</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      id="school"
                      v-model="signupForm.school"
                      placeholder="í•™êµëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                      readonly
                      required
                    >
                    <button
                      class="btn btn-outline-primary"
                      type="button"
                      @click="openSchoolSearchModal"
                    >
                      <i class="fas fa-search me-1"></i>
                      í•™êµ ê²€ìƒ‰
                    </button>
                  </div>
                  <small v-if="schoolSearchResults.length > 0" class="text-muted">
                    ê²€ìƒ‰ ê²°ê³¼: {{ schoolSearchResults.length }}ê°œ í•™êµ
                  </small>
                </div>

                <!-- ê°€ì…ì™„ë£Œ ë²„íŠ¼ -->
                <div class="d-flex gap-3">
                  <button type="button" @click="prevStep" class="btn btn-secondary flex-fill">
                    <i class="fas fa-arrow-left me-2"></i>
                    ì´ì „
                  </button>
                  <button type="submit" class="btn btn-primary flex-fill">
                    <i class="fas fa-check me-2"></i>
                    ê°€ì…ì™„ë£Œ
                  </button>
                </div>
              </form>
            </div>

            <!-- ë¡œê·¸ì¸ ë§í¬ -->
            <div class="text-center mt-4">
              <p class="mb-0">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? 
                <router-link to="/login" class="text-decoration-none fw-bold">ë¡œê·¸ì¸</router-link>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- í•™êµ ê²€ìƒ‰ ëª¨ë‹¬ -->
  <div v-if="showSchoolModal" class="modal-overlay" @click="closeSchoolModal">
    <div class="modal-content" @click.stop>
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-school me-2"></i>
          í•™êµ ê²€ìƒ‰
        </h5>
        <button type="button" class="btn-close" @click="closeSchoolModal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- ê²€ìƒ‰ ì…ë ¥ -->
        <div class="mb-3">
          <div class="input-group">
            <input 
              type="text" 
              class="form-control" 
              v-model="schoolSearchKeyword"
              @keyup.enter="searchSchools"
              placeholder="í•™êµëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
            >
            <button 
              class="btn btn-primary" 
              @click="searchSchools"
              :disabled="!schoolSearchKeyword.trim() || isSchoolSearching"
            >
              <span v-if="isSchoolSearching" class="spinner-border spinner-border-sm me-2" role="status"></span>
              {{ isSchoolSearching ? 'ê²€ìƒ‰ ì¤‘...' : 'ê²€ìƒ‰' }}
            </button>
          </div>
        </div>

        <!-- ê²€ìƒ‰ ê²°ê³¼ -->
        <div v-if="schoolSearchResults.length > 0" class="mb-3">
          <h6 class="fw-bold mb-2">ê²€ìƒ‰ ê²°ê³¼ ({{ schoolSearchResults.length }}ê±´)</h6>
          <div class="list-group">
            <button 
              v-for="school in schoolSearchResults" 
              :key="school.id"
              type="button"
              class="list-group-item list-group-item-action"
              @click="selectSchool(school)"
            >
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1 fw-bold">{{ school.schoolName }}</h6>
                  <p class="mb-1 text-muted small">
                    {{ school.addressRoad || school.addressJibun }}
                  </p>
                  <small class="text-muted">
                    {{ school.sidoOffice }} | {{ school.eduOffice }}
                  </small>
                </div>
                <i class="fas fa-chevron-right text-muted"></i>
              </div>
            </button>
          </div>
        </div>

        <!-- ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ -->
        <div v-else-if="schoolSearchKeyword && !isSchoolSearching" class="text-center py-4">
          <i class="fas fa-search fa-2x text-muted mb-3"></i>
          <p class="text-muted mb-0">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- ì´ˆê¸° ìƒíƒœ -->
        <div v-else-if="!schoolSearchKeyword" class="text-center py-4">
          <i class="fas fa-school fa-2x text-muted mb-3"></i>
          <p class="text-muted mb-0">í•™êµëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.</p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted, onUnmounted } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'

const router = useRouter()

// ë°˜ì‘í˜• ë°ì´í„°
const signupStep = ref(1)

// íšŒì›ê°€ì… í¼
const signupForm = ref({
  userType: '',
  username: '',
  password: '',
  passwordConfirm: '',
  email: '',
  phone: '',
  birthDate: '',
  school: ''
})

// ì•½ê´€ ë™ì˜
const agreements = ref({
  all: false,
  terms: false,
  privacy: false,
  marketing: false
})

// íœ´ëŒ€í° ì¸ì¦
const verificationSent = ref(false)
const verificationCode = ref('')
const phoneVerified = ref(false)
const verificationTimer = ref(180)
let timerInterval = null

// ì•„ì´ë”” ì¤‘ë³µ í™•ì¸
const usernameCheckMessage = ref('')
const usernameAvailable = ref(false)

// ë¹„ë°€ë²ˆí˜¸ ê°•ë„
const passwordStrength = ref('')
const passwordStrengthClass = ref('')
const passwordStrengthText = ref('')

// ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ/ìˆ¨ê¹€ ìƒíƒœ
const showPassword = ref(false)
const showPasswordConfirm = ref(false)

// ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
const emailValid = ref(false)
const emailErrorMessage = ref('')

// í•™êµ ê²€ìƒ‰
const showSchoolModal = ref(false)
const schoolSearchKeyword = ref('')
const schoolSearchResults = ref([])
const isSchoolSearching = ref(false)

// API ì„¤ì •
const apiBaseUrl = 'http://localhost:8080/api'

// computed properties
const canProceedToStep2 = computed(() => {
  return agreements.value.terms && agreements.value.privacy && signupForm.value.userType
})

const isValidPhone = computed(() => {
  const phoneRegex = /^010-\d{4}-\d{4}$/
  return phoneRegex.test(signupForm.value.phone)
})

const passwordsMatch = computed(() => {
  return signupForm.value.password === signupForm.value.passwordConfirm
})

const passwordStrengthWidth = computed(() => {
  if (!passwordStrength.value) return '0%'
  const strength = passwordStrength.value
  if (strength <= 2) return '33%'
  if (strength <= 3) return '66%'
  return '100%'
})

// ë©”ì„œë“œë“¤
const toggleAllAgreements = () => {
  agreements.value.terms = agreements.value.all
  agreements.value.privacy = agreements.value.all
  agreements.value.marketing = agreements.value.all
}

const checkIndividualAgreements = () => {
  if (agreements.value.terms && agreements.value.privacy && agreements.value.marketing) {
    agreements.value.all = true
  } else {
    agreements.value.all = false
  }
}

const formatPhone = () => {
  let phone = signupForm.value.phone.replace(/[^0-9]/g, '')
  if (phone.length > 3 && phone.length <= 7) {
    phone = phone.slice(0, 3) + '-' + phone.slice(3)
  } else if (phone.length > 7) {
    phone = phone.slice(0, 3) + '-' + phone.slice(3, 7) + '-' + phone.slice(7, 11)
  }
  signupForm.value.phone = phone
}

const sendVerificationCode = async () => {
  // í…ŒìŠ¤íŠ¸ìš© ë²ˆí˜¸ ì²´í¬
  if (signupForm.value.phone === '010-1111-1111') {
    verificationSent.value = true
    startTimer()
    alert('(í…ŒìŠ¤íŠ¸) ì¸ì¦ë²ˆí˜¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì¸ì¦ë²ˆí˜¸: 000000')
    return
  }

  try {
    const response = await axios.post(`${apiBaseUrl}/auth/phone/send`, {
      phone: signupForm.value.phone
    })

    if (response.data.success) {
      verificationSent.value = true
      startTimer()
      alert('ì¸ì¦ë²ˆí˜¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.')
    }
  } catch (error) {
    alert('ì¸ì¦ë²ˆí˜¸ ì „ì†¡ ì‹¤íŒ¨: ' + (error.response?.data?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'))
  }
}

const startTimer = () => {
  verificationTimer.value = 180
  timerInterval = setInterval(() => {
    verificationTimer.value--
    if (verificationTimer.value <= 0) {
      clearInterval(timerInterval)
      verificationSent.value = false
    }
  }, 1000)
}

const verifyPhone = async () => {
  // í…ŒìŠ¤íŠ¸ìš© ì¸ì¦ ì²´í¬
  if (signupForm.value.phone === '010-1111-1111' && verificationCode.value === '000000') {
    phoneVerified.value = true
    clearInterval(timerInterval)
    alert('(í…ŒìŠ¤íŠ¸) íœ´ëŒ€í° ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.')
    return
  }

  try {
    const response = await axios.post(`${apiBaseUrl}/auth/phone/verify`, {
      phone: signupForm.value.phone,
      code: verificationCode.value
    })

    if (response.data.success) {
      phoneVerified.value = true
      clearInterval(timerInterval)
      alert('íœ´ëŒ€í° ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.')
    }
  } catch (error) {
    alert('ì¸ì¦ ì‹¤íŒ¨: ' + (error.response?.data?.message || 'ì˜ëª»ëœ ì¸ì¦ë²ˆí˜¸ì…ë‹ˆë‹¤.'))
  }
}

const checkUsernameAvailability = async () => {
  if (!signupForm.value.username) {
    usernameCheckMessage.value = 'ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'
    usernameAvailable.value = false
    return
  }

  try {
    const response = await axios.get(`${apiBaseUrl}/users/check/username/${signupForm.value.username}`)

    if (response.data.success) {
      usernameCheckMessage.value = 'ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.'
      usernameAvailable.value = true
    } else {
      usernameCheckMessage.value = 'ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'
      usernameAvailable.value = false
    }
  } catch {
    usernameCheckMessage.value = 'ì¤‘ë³µ í™•ì¸ ì‹¤íŒ¨'
    usernameAvailable.value = false
  }
}

const togglePasswordVisibility = () => {
  showPassword.value = !showPassword.value
}

const togglePasswordConfirmVisibility = () => {
  showPasswordConfirm.value = !showPasswordConfirm.value
}

const validateEmail = (email) => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  return emailRegex.test(email)
}

const checkEmailFormat = () => {
  const email = signupForm.value.email

  if (!email) {
    emailValid.value = false
    emailErrorMessage.value = ''
    return
  }

  if (!validateEmail(email)) {
    emailValid.value = false
    emailErrorMessage.value = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'
  } else {
    emailValid.value = true
    emailErrorMessage.value = ''
  }
}

const checkPasswordStrength = () => {
  const password = signupForm.value.password

  if (!password) {
    passwordStrength.value = ''
    return
  }

  const hasLower = /[a-z]/.test(password)
  const hasUpper = /[A-Z]/.test(password)
  const hasNumber = /[0-9]/.test(password)
  const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password)
  const isLongEnough = password.length >= 9 && password.length <= 20

  let strength = 0
  if (hasLower) strength++
  if (hasUpper) strength++
  if (hasNumber) strength++
  if (hasSpecial) strength++
  if (isLongEnough) strength++

  if (strength >= 5) {
    passwordStrengthClass.value = 'bg-success'
    passwordStrengthText.value = 'ë³´ì•ˆ ìš°ìˆ˜'
  } else if (strength >= 3) {
    passwordStrengthClass.value = 'bg-warning'
    passwordStrengthText.value = 'ë³´ì•ˆ ì–‘í˜¸'
  } else {
    passwordStrengthClass.value = 'bg-danger'
    passwordStrengthText.value = 'ë³´ì•ˆ ì·¨ì•½'
  }

  passwordStrength.value = true
}

const openSchoolSearchModal = () => {
  console.log('ğŸ” openSchoolSearchModal í•¨ìˆ˜ ì‹¤í–‰ ì‹œì‘')
  showSchoolModal.value = true
  schoolSearchKeyword.value = ''
  schoolSearchResults.value = []
  console.log('ğŸ” openSchoolSearchModal í•¨ìˆ˜ ì‹¤í–‰ ì™„ë£Œ')
}

const closeSchoolModal = () => {
  showSchoolModal.value = false
  schoolSearchKeyword.value = ''
  schoolSearchResults.value = []
}

const searchSchools = async () => {
  console.log('ğŸš€ searchSchools í•¨ìˆ˜ ì‹¤í–‰ ì‹œì‘')
  console.log('ğŸš€ schoolSearchKeyword.value:', schoolSearchKeyword.value)
  
  if (!schoolSearchKeyword.value.trim()) {
    console.log('ğŸš€ ê²€ìƒ‰ì–´ê°€ ì—†ì–´ì„œ í•¨ìˆ˜ ì¢…ë£Œ')
    return
  }

  isSchoolSearching.value = true

  try {
    console.log('í•™êµ ê²€ìƒ‰ ì‹œì‘ (ì‹¤ì œ API):', schoolSearchKeyword.value.trim())

    // ì‹¤ì œ APIë¡œ í•™êµ ê²€ìƒ‰
    const keyword = schoolSearchKeyword.value.trim()
    console.log('ê²€ìƒ‰ í‚¤ì›Œë“œ:', keyword)
    console.log('ê²€ìƒ‰ í‚¤ì›Œë“œ ê¸¸ì´:', keyword.length)
    console.log('ê²€ìƒ‰ í‚¤ì›Œë“œ ë°”ì´íŠ¸:', new TextEncoder().encode(keyword))
    
    const response = await axios.get(`http://localhost:8080/api/schools/search?keyword=${encodeURIComponent(keyword)}`)
    console.log('ê²€ìƒ‰ ê²°ê³¼:', response.data)
    schoolSearchResults.value = response.data
  } catch (error) {
    console.error('í•™êµ ê²€ìƒ‰ ì‹¤íŒ¨:', error)
    console.error('ì—ëŸ¬ ìƒì„¸:', error.response?.data)
    console.error('ì—ëŸ¬ ìƒíƒœ:', error.response?.status)
    schoolSearchResults.value = []
    alert('í•™êµ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.')
  } finally {
    isSchoolSearching.value = false
  }
}

const selectSchool = (school) => {
  signupForm.value.school = school.schoolName
  closeSchoolModal()
}

const nextStep = () => {
  if (signupStep.value < 3) {
    signupStep.value++
  }
}

const prevStep = () => {
  if (signupStep.value > 1) {
    signupStep.value--
  }
}

const handleSignup = async () => {
  if (signupForm.value.password !== signupForm.value.passwordConfirm) {
    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
    return
  }

  if (!usernameAvailable.value) {
    alert('ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.')
    return
  }

  if (!emailValid.value) {
    alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.')
    return
  }

  if (!signupForm.value.school.trim()) {
    alert('í•™êµ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.')
    return
  }

  try {
    const signupData = {
      username: signupForm.value.username,
      password: signupForm.value.password,
      email: signupForm.value.email,
      phone: signupForm.value.phone,
      birthDate: signupForm.value.birthDate,
      fullName: signupForm.value.username,
      role: signupForm.value.userType.toUpperCase(),
      school: signupForm.value.school,
      marketingAgree: agreements.value.marketing
    }

    const response = await axios.post(`${apiBaseUrl}/auth/register`, signupData)

    if (response.data.success) {
      alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.')
      router.push('/login')
    } else {
      alert('íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + response.data.message)
    }
  } catch (error) {
    alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + (error.response?.data?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'))
  }
}

// ê°ì‹œì
watch(() => signupForm.value.phone, () => {
  formatPhone()
})

// ìƒëª…ì£¼ê¸° í›…
onMounted(() => {
  console.log('Signup ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì™„ë£Œ')
})

onUnmounted(() => {
  if (timerInterval) {
    clearInterval(timerInterval)
  }
})
</script>

<style scoped>
.card {
  border-radius: 1rem;
}

.card-header {
  border-radius: 1rem 1rem 0 0 !important;
}

.section-title {
  color: #495057;
  font-weight: 600;
  border-bottom: 2px solid #e9ecef;
  padding-bottom: 0.5rem;
}

/* ë‹¨ê³„ í‘œì‹œ ìŠ¤íƒ€ì¼ */
.step-indicator {
  margin-bottom: 2rem;
}

.step {
  text-align: center;
  padding: 1rem;
  background: #f8f9fa;
  border-radius: 0.75rem;
  border: 2px solid #e9ecef;
  transition: all 0.3s ease;
  position: relative;
}

.step.active {
  background: #0d6efd;
  border-color: #0d6efd;
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

.step.completed {
  background: #198754;
  border-color: #198754;
  color: white;
}

.step-number {
  font-size: 1.5rem;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.step-text {
  font-size: 0.875rem;
  line-height: 1.2;
}

/* ì‚¬ìš©ì ìœ í˜• ì„ íƒ ì¹´ë“œ */
.user-type-card {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 0.75rem;
  padding: 1.5rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.user-type-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: #0d6efd;
}

.user-type-card.active {
  background: #e7f1ff;
  border-color: #0d6efd;
  box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
}

.user-type-icon {
  color: #6c757d;
  margin-bottom: 1rem;
}

.user-type-card.active .user-type-icon {
  color: #0d6efd;
}

.user-type-title {
  margin: 0;
  font-weight: 600;
  color: #495057;
}

.user-type-card.active .user-type-title {
  color: #0d6efd;
}

/* í¼ ìŠ¤íƒ€ì¼ */
.form-control:focus,
.form-select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn-primary {
  background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
  border: none;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

.progress {
  border-radius: 10px;
  background-color: #e9ecef;
}

.progress-bar {
  border-radius: 10px;
  transition: width 0.3s ease;
}

.list-group-item {
  border-left: none;
  border-right: none;
  transition: all 0.2s ease;
}

.list-group-item:hover {
  background-color: #f8f9fa;
  transform: translateX(5px);
}

.list-group-item:first-child {
  border-top: none;
}

.list-group-item:last-child {
  border-bottom: none;
}

/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 1rem;
  border: none;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow: hidden;
}

.modal-header {
  border-bottom: 1px solid #e9ecef;
  border-radius: 1rem 1rem 0 0;
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-body {
  padding: 1.5rem;
  max-height: 60vh;
  overflow-y: auto;
}

.form-check-input:checked {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

.form-check-input:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
  .card-body {
    padding: 2rem !important;
  }
  
  .col-12 {
    padding: 0 1rem;
  }
  
  .step-text {
    font-size: 0.75rem;
  }
  
  .user-type-card {
    padding: 1rem;
  }
}
</style>
