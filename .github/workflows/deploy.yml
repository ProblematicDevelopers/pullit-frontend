name: Frontend Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build project
      env:
        VITE_API_URL: http://${{ secrets.EC2_HOST }}/api
      run: npm run build
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # 새 빌드 파일을 임시 디렉토리로 복사
          mkdir -p /home/ubuntu/app/pullit/frontend-new
          
    - name: Copy build files
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "dist/*"
        target: "/home/ubuntu/app/pullit/frontend-new"
        strip_components: 1
    
    - name: Switch frontend with zero downtime
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ubuntu/app/pullit
          
          # 기존 frontend를 백업
          if [ -d "frontend" ]; then
            rm -rf frontend-old
            mv frontend frontend-old
          fi
          
          # 새 frontend로 전환
          mv frontend-new frontend
          
          # Nginx는 이미 새 파일을 참조하게 됨 (심볼릭 링크 없이도 무중단)
          # 필요시 Nginx 리로드 (설정 변경 없으면 불필요)
          # docker exec pullit-nginx nginx -s reload
          
          echo "Frontend deployment completed successfully!"