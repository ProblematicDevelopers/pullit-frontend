name: Frontend Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build project
      env:
        VITE_API_URL: http://${{ secrets.EC2_HOST }}/api
      run: npm run build
    
    - name: Copy build files
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "dist/*"
        target: "/home/ubuntu/app/pullit/frontend-builds/${{ github.sha }}"
        strip_components: 1
    
    - name: Deploy with zero downtime
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ubuntu/app/pullit
          
          # íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BUILD_ID="${{ github.sha }}"
          
          # ìƒˆ ë¹Œë“œ ë””ë ‰í† ë¦¬ í™•ì¸
          if [ ! -d "frontend-builds/${BUILD_ID}" ]; then
            echo "âŒ Build directory not found!"
            exit 1
          fi
          
          # í˜„ì¬ frontendê°€ ì‹¬ë³¼ë¦­ ë§í¬ì¸ì§€ í™•ì¸
          if [ -L "frontend/dist" ]; then
            # ì´ì „ ë¹Œë“œ ë””ë ‰í† ë¦¬ ì €ì¥
            OLD_BUILD=$(readlink frontend/dist)
            echo "Current build: $OLD_BUILD"
          fi
          
          # dist ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
          mkdir -p frontend
          
          # ìµœì´ˆ ë°°í¬ì¸ì§€ í™•ì¸
          if [ ! -e "frontend/dist" ]; then
            echo "ğŸš€ First deployment detected!"
            # ìµœì´ˆ ë°°í¬ ì‹œ ì§ì ‘ ë³µì‚¬
            cp -r frontend-builds/${BUILD_ID} frontend/dist
          else
            # ìƒˆ ë¹Œë“œë¡œ ì‹¬ë³¼ë¦­ ë§í¬ ì›ìì  ì „í™˜
            ln -sfn $(pwd)/frontend-builds/${BUILD_ID} frontend/dist
          fi
          
          # ê¶Œí•œ ì„¤ì •
          chmod -R 755 frontend-builds/${BUILD_ID}
          chmod 755 frontend/
          
          # Nginx ì„¤ì • ë¦¬ë¡œë“œ (ë¬´ì¤‘ë‹¨)
          if docker ps | grep -q pullit-nginx; then
            docker exec pullit-nginx nginx -s reload
            echo "âœ… Nginx reloaded - Zero downtime deployment successful!"
          else
            echo "âš ï¸  Nginx not running - Starting services..."
            docker-compose -f docker-compose-server.yml up -d
          fi
          
          # ì˜¤ë˜ëœ ë¹Œë“œ ì •ë¦¬ (ìµœê·¼ 3ê°œë§Œ ìœ ì§€)
          cd frontend-builds
          ls -t | tail -n +4 | xargs -r rm -rf
          
          echo "Frontend deployment completed successfully!"
          echo "Build ID: ${BUILD_ID}"